
### ※ 文档摘要

　　本文档说明如何进行分页查询。

### ※ 依赖

　　要进行分页查询，需要依赖以下类库：

 + Macroview-DB : 数据库存取类
 
 + Macroview-App-Base ：对分页技术进行封装
 
 + Macroview-web-resources ：前端资源（包括 Tag 等）

### ※ 分页工作

　　分页操作实现，通常分成两端：
 
 + 服务器端响应
 
 + 前端显示与操作

 
#### ■ 服务器端工作

 + **定义一个继承自 `DefaultPageBean` 的数据Bean，包含了查询内容**

```Java
//示例
/**
 * 查询 Bean
 *
 * @author Jai
 * @since: v1.0
 */
public class AdminLoggerQueryBean extends DefaultPageBean{

	/**
	 * 日志类型
	 */
	private OpType opType;
	
	/**
	 * 管理员帐号
	 */
	private String user;
	
	/**
	 * 模块名称查询
	 */
	private String moduleName;
	
	/**
	 * 使用时间范围查询
	 */
	@Between
	private DateTimeRange createTime;

	/**
	 * 不参加查询，对应  Web 的开始时间
	 */
	@NotNamed
	private Date beginTime;
	
	@NotNamed
	private Date endTime;
	
	/**
	 * @return the opType
	 */
	public OpType getOpType() {
		return opType;
	}

	/**
	 * @param opType the opType to set
	 */
	public void setOpType(OpType opType) {
		this.opType = opType;
	}

	/**
	 * @return the user
	 */
	public String getUser() {
		return user;
	}

	/**
	 * @param user the user to set
	 */
	public void setUser(String user) {
		this.user = user;
	}

	/**
	 * 时间的查询范围
	 * @return the createTime
	 */
	public DateTimeRange getCreateTime() {
		if(beginTime == null || endTime == null)
			return null;
		
		createTime = new DateTimeRange(beginTime, endTime);
		
		return this.createTime;
	}

	/**
	 * @return the beginTime
	 */
	public Date getBeginTime() {
		return beginTime;
	}

	/**
	 * @param beginTime the beginTime to set
	 */
	public void setBeginTime(Date beginTime) {
		this.beginTime = beginTime;
	}

	/**
	 * @return the endTime
	 */
	public Date getEndTime() {
		return endTime;
	}

	/**
	 * @param endTime the endTime to set
	 */
	public void setEndTime(Date endTime) {
		this.endTime = endTime;
	}

	/**
	 * @return the moduleName
	 */
	public String getModuleName() {
		return moduleName;
	}

	/**
	 * @param moduleName the moduleName to set
	 */
	public void setModuleName(String moduleName) {
		this.moduleName = moduleName;
	}
}
``` 
 
　　由于分页往往会与查询结合（提供一些查询条件），所以我们可以在查询类中，使用查询注解来定义要查询的字段（客户端提交的查询字段与值）。

　　分页与查询的结合，目的在于避免人工拼接查询语句，减少拼接工作量与错误。

 + **在 `Action`（请求处理类）中处理分页请求方法**

```java
/**
 * 管理日志模块 Action
 *
 * @author Jai
 * @since: v1.0
 */
@Controller(path="/admin/adminlogger")
public class AdminLoggerAction {

	private final static Logger logger = Logger.getLogger(AdminLoggerAction.class);
	
	private AdminLoggerService loggerSrvice = new AdminLoggerService(); 
	
	/**
	 * Get /admin/manager-logger/list
	 *
	 * @return
	 */
	@Get
	public ModelAndView list(AdminLoggerQueryBean queryBean){
		logger.info("[AdminLogger]==> 日志列表与查询，值：" + queryBean);
		
		ModelAndView mv = new ModelAndView("admin/adminlogger/logger_list");
		try{
		      // 将查询结果放入到 loggers 当中
			mv.addObject("loggers", AdminLogger.dao.queryWithPagination(queryBean));			
		}catch(Exception e){
			logger.error("[AdminLogger 查询]==> 日志查询失败，查询数据：" + queryBean + "，异常信息：", e);
		}
				
		return mv;
	}
}
```

 + **服务器端向前端提供的标准数据**
 
   - content: 属性，这是查询结果列表（记录对象列表）
   
   - hasContent : 属性，表示是否有查询结果
   
   - totalPages： 属性，表示总页数
   
   - pageNo：属性，当前页码
   
   - pageSize：属性，当前页大小


#### ■ 前端显示与操作
 
　　服务器端工作完成之后，就需要组织前端进行显示工作，前端的显示有三部分：

 + 查询栏内容（即输入查询条件）
 
 + 列表内容（表格显示记录）
 
 + 分页栏（显示页码序列）

　　在本示例当中，查询栏内容略（都是使用 Form 来构建），只给出后面两部分，并且这两部分都可以使用 `Tag` 来完成。

　　下面示例是分别使用 `Table` 和 `Pagination tag` 来构建的示例：

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ page isELIgnored="false"%>
<%@ taglib uri="/WEB-INF/c.tld" prefix="c"%>
<%@ taglib uri="/WEB-INF/fmt.tld" prefix="f"%>  
<%@ taglib uri="/WEB-INF/fn.tld" prefix="fn" %>
<%@ taglib tagdir="/WEB-INF/tags/macroview" prefix="mv"%>

			<!-- 日志内容表 -->
	<table id="logger-list-table" class="table table-striped table-hover" rol="table">
		<thead> <!-- 表格头 -->
			<tr>
				<th width="30">#</th>
				<th width="60"><mv:i18n message="mwf.commons.type"/></th>
				<th width="100"><mv:i18n message="mwf.commons.module"/></th>
				<th width="80"><mv:i18n message="mwf.account.role.admin"/></th>
				<th width="100"><mv:i18n message="mwf.commons.operation"/>IP</th>
				<th><mv:i18n message="mwf.admin.logger.content"/></th>
				<th width="60"><mv:i18n message="mwf.commons.result"/></th>
				<th width="120"><mv:i18n message="mwf.commons.time"/></th>
			</tr>
		</thead>
		<tbody> <!-- 表格记录内容 -->
			<c:choose>
				<c:when test="${loggers.hasContent}">
				  <c:set var="i" value="1"/>
				  <c:forEach items="${loggers.content}" var="logger">
				  	<tr>
				  		<td><a href="#" class="display_content_btn" title="<mv:i18n message='mwf.commons.show.detail'/>" data-loggerid="${logger.id}">${i}</a></td>
				  		<td>${logger.opType.displayName }</td>
				  		<td>${logger.moduleName }</td>
				  		<td>${logger.user}</td>
				  		<td>${logger.operaterIp }</td>
				  		<td style="word-wrap:break-word; word-break:break-all;">${logger.newValue}</td>
				  		<td>${logger.opStatus }</td>
				  		<td><f:formatDate pattern="yyyy/MM/dd HH:mm:ss" value="${logger.createTime}" /></td>
				  	</tr>
				  	<c:set var="i" value="${i+1 }"/>
				  </c:forEach>	
				</c:when>
				<c:otherwise>
					<tr>
						<td colspan="8">
							<strong><mv:i18n message="mwf.tag.table.norecord"/></strong>
						</td>
					</tr>
				</c:otherwise>
			</c:choose>
		</tbody>	
	</table>
	<div id="logger_page_div" class="row">
		<mv:pagination id="logger_pagination" totals="${loggers.totalPages}"
					pageNo="${loggers.pageNo }" pageSize="${loggers.pageSize }" />
	</div>
```

　　这样做比较灵活，但是如果不需要对表格内容进行定制的话，可以使用一个 `Table tag` 来实际全部内容：

```jsp
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ page isELIgnored="false"%>
<%@ taglib uri="/WEB-INF/c.tld" prefix="c"%>
<%@ taglib uri="/WEB-INF/fmt.tld" prefix="f"%>  
<%@ taglib uri="/WEB-INF/fn.tld" prefix="fn" %>
<%@ taglib tagdir="/WEB-INF/tags/macroview" prefix="mv"%>

<form id="query_logger_form" action="...">
    <div class="row">
      <!-- 查询栏内容 -->
    </div>
    
	<div class="row">
		<!-- 表格标签 -->
		<mv:table id="logger-list-table" items="${loggers}" tableClass="logger-table" pagination="true" onPageGoto="myGotoPage">
			<mv:column property="#"/>
			<mv:column property="opType.displayName" width="160" title="%mwf.commons.type"/>
			<mv:column property="moduleName" width="160" title="%mwf.commons.module" />
			<mv:column property="user" title="%mwf.account.role.admin" />
			<mv:column property="operaterIp" title="%mwf.commons.operation" />
			<mv:column property="newValue" width="80" title="%mwf.admin.logger.conten"/>
			<mv:column property="opStatus" title="%mwf.commons.result" />
			<mv:column property="createTime" width="180" title="%mwf.commons.time" propertyType="Date" format="yyyy/MM/dd HH:mm:ss"/>
		</mv:table>	
	</div>
</form>

<script type="text/javascript">

	/**
	 * 分页跳转
	 */
	function myGotoPage(pageNo){
		$("#query_logger_form").submit();
	}
	
</script>	
```



 